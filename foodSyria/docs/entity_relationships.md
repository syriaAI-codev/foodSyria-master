# تحليل العلاقات بين الكيانات في تطبيق توصيل الطعام

## الكيانات الرئيسية

### 1. المستخدمون (users)
- يمثل جميع مستخدمي النظام بأدوارهم المختلفة (عميل، صاحب مطعم، عامل توصيل، مدير)
- يرتبط بجدول المصادقة الخاص بـ Supabase (auth.users)
- يحتوي على معلومات المستخدم الأساسية (الاسم، رقم الهاتف، العنوان، الدور)

### 2. المطاعم (restaurants)
- يمثل المطاعم المسجلة في النظام
- يرتبط بمستخدم من نوع "صاحب مطعم" (restaurant owner)
- يحتوي على معلومات المطعم (الاسم، الوصف، رقم الهاتف، العنوان، الموقع الجغرافي)

### 3. عناصر القائمة (menu_items)
- يمثل الأطعمة المتوفرة في قائمة كل مطعم
- يرتبط بمطعم محدد
- يحتوي على معلومات العنصر (الاسم، الوصف، السعر، الصورة، حالة التوفر)

### 4. الطلبات (orders)
- يمثل طلبات الطعام من العملاء
- يرتبط بعميل ومطعم محددين
- يحتوي على معلومات الطلب (العنوان، الموقع الجغرافي، الحالة، السعر الإجمالي، طريقة الدفع)

### 5. عناصر الطلب (order_items)
- يمثل العناصر المطلوبة في كل طلب
- يرتبط بطلب وعنصر قائمة محددين
- يحتوي على معلومات العنصر المطلوب (الكمية، السعر وقت الطلب)

### 6. عمال التوصيل (delivery_persons)
- يمثل معلومات إضافية لمستخدمي النظام من نوع "عامل توصيل"
- يرتبط بمستخدم من نوع "عامل توصيل"
- يحتوي على معلومات حالة التوفر والموقع الحالي

### 7. عمليات التوصيل (deliveries)
- يمثل عمليات توصيل الطلبات
- يرتبط بطلب وعامل توصيل محددين
- يحتوي على معلومات عملية التوصيل (الحالة، وقت الاستلام، وقت التسليم)

## العلاقات بين الكيانات

1. **المستخدم - المطعم**:
   - علاقة واحد لواحد (1:1) أو واحد لكثير (1:N) - مستخدم من نوع "صاحب مطعم" يمكن أن يملك مطعم واحد أو أكثر
   - حقل `owner_id` في جدول `restaurants` يشير إلى `id` في جدول `users`

2. **المطعم - عناصر القائمة**:
   - علاقة واحد لكثير (1:N) - مطعم واحد يمكن أن يحتوي على عدة عناصر قائمة
   - حقل `restaurant_id` في جدول `menu_items` يشير إلى `id` في جدول `restaurants`

3. **المستخدم (العميل) - الطلبات**:
   - علاقة واحد لكثير (1:N) - عميل واحد يمكن أن يقوم بعدة طلبات
   - حقل `customer_id` في جدول `orders` يشير إلى `id` في جدول `users`

4. **المطعم - الطلبات**:
   - علاقة واحد لكثير (1:N) - مطعم واحد يمكن أن يتلقى عدة طلبات
   - حقل `restaurant_id` في جدول `orders` يشير إلى `id` في جدول `restaurants`

5. **الطلب - عناصر الطلب**:
   - علاقة واحد لكثير (1:N) - طلب واحد يمكن أن يحتوي على عدة عناصر
   - حقل `order_id` في جدول `order_items` يشير إلى `id` في جدول `orders`

6. **عنصر القائمة - عناصر الطلب**:
   - علاقة واحد لكثير (1:N) - عنصر قائمة واحد يمكن أن يكون في عدة طلبات
   - حقل `menu_item_id` في جدول `order_items` يشير إلى `id` في جدول `menu_items`

7. **المستخدم (عامل التوصيل) - عمال التوصيل**:
   - علاقة واحد لواحد (1:1) - مستخدم من نوع "عامل توصيل" يرتبط بسجل واحد في جدول عمال التوصيل
   - حقل `user_id` في جدول `delivery_persons` يشير إلى `id` في جدول `users`

8. **الطلب - عمليات التوصيل**:
   - علاقة واحد لواحد (1:1) - طلب واحد يرتبط بعملية توصيل واحدة
   - حقل `order_id` في جدول `deliveries` يشير إلى `id` في جدول `orders`

9. **عامل التوصيل - عمليات التوصيل**:
   - علاقة واحد لكثير (1:N) - عامل توصيل واحد يمكن أن يقوم بعدة عمليات توصيل
   - حقل `delivery_person_id` في جدول `deliveries` يشير إلى `user_id` في جدول `delivery_persons`

## ملاحظات مهمة حول العلاقات

1. **حذف المتسلسل (Cascading Delete)**:
   - عند حذف مستخدم من نوع "صاحب مطعم"، يجب حذف المطعم المرتبط به
   - عند حذف مطعم، يجب حذف جميع عناصر القائمة المرتبطة به
   - عند حذف طلب، يجب حذف جميع عناصر الطلب المرتبطة به
   - عند حذف مستخدم من نوع "عامل توصيل"، يجب حذف سجل عامل التوصيل المرتبط به

2. **سياسات أمان الصفوف (Row Level Security)**:
   - يجب تطبيق سياسات أمان الصفوف لضمان أن المستخدمين يمكنهم الوصول فقط إلى البيانات المسموح بها حسب دورهم
   - العملاء يمكنهم الوصول فقط إلى طلباتهم الخاصة
   - أصحاب المطاعم يمكنهم الوصول فقط إلى مطاعمهم وعناصر القائمة والطلبات المرتبطة بمطاعمهم
   - عمال التوصيل يمكنهم الوصول فقط إلى عمليات التوصيل المسندة إليهم
   - المديرون يمكنهم الوصول إلى جميع البيانات

3. **المعاملات (Transactions)**:
   - يجب استخدام المعاملات عند إنشاء الطلبات وعناصر الطلب للحفاظ على تكامل البيانات
   - يجب استخدام المعاملات عند تحديث حالة الطلب وعملية التوصيل المرتبطة به
